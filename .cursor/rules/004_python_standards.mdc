---
description: Python coding standards
priority: 30
globs:
  - "**/*.py"
keywords:
  - python
---

# Python Standards

## Type Hints

Use type hints for all public functions:

✅ **CORRECT**:
```python
def calculate_total(prices: list[float], tax_rate: float) -> float:
    """Calculate total price including tax."""
    subtotal = sum(prices)
    return subtotal * (1 + tax_rate)
```

❌ **WRONG** (no type hints):
```python
def calculate_total(prices, tax_rate):
    subtotal = sum(prices)
    return subtotal * (1 + tax_rate)
```

## Avoid Global Mutable State

❌ **WRONG**:
```python
# Global mutable state
config = {}

def update_config(key, value):
    config[key] = value  # BAD: Modifies global state
```

✅ **CORRECT**:
```python
from dataclasses import dataclass

@dataclass
class Config:
    """Configuration with immutable defaults."""
    timeout: int = 30
    retries: int = 3

def create_config(**kwargs) -> Config:
    """Create new config instance."""
    return Config(**kwargs)
```

## Structured Logging

✅ **CORRECT**:
```python
import logging

logger = logging.getLogger(__name__)

def process_file(filepath: str) -> None:
    """Process a file with structured logging."""
    logger.info("Processing file", extra={"filepath": filepath})
    try:
        # ... processing logic
        logger.info("File processed successfully", extra={"filepath": filepath})
    except Exception as e:
        logger.error("Failed to process file", 
                    extra={"filepath": filepath, "error": str(e)})
        raise
```

## External Calls with Timeouts

ALWAYS use timeouts for external calls:

✅ **CORRECT**:
```python
import subprocess

def run_command(cmd: list[str], timeout: int = 30) -> subprocess.CompletedProcess:
    """Run command with timeout."""
    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=timeout,
            check=True  # Raise on non-zero exit
        )
        return result
    except subprocess.TimeoutExpired:
        raise RuntimeError(f"Command timed out after {timeout}s: {' '.join(cmd)}")
```

## Avoid shell=True

❌ **WRONG** (security risk):
```python
subprocess.run(f"rm -rf {user_dir}", shell=True)  # DANGEROUS!
```

✅ **CORRECT** (safe):
```python
subprocess.run(["rm", "-rf", user_dir], check=True)
```

## CLI Tools Must Support --help

✅ **CORRECT**:
```python
import argparse

def main() -> None:
    parser = argparse.ArgumentParser(
        description="Process data files"
    )
    parser.add_argument(
        "input_file",
        help="Path to input file"
    )
    parser.add_argument(
        "--timeout",
        type=int,
        default=30,
        help="Timeout in seconds (default: 30)"
    )
    args = parser.parse_args()
    # ... implementation
```

## Prefer Standard Library

Use standard library when possible. Avoid unnecessary dependencies.

✅ **GOOD** (standard library):
```python
import json
from pathlib import Path
from dataclasses import dataclass
```

⚠️ **Consider alternatives** before adding external dependencies
